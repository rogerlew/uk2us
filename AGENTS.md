# uk2us Agent Notes

## Purpose
`uk2us` provides a CLI for converting British spellings to American spellings using the upstream HoldOffHunger data set. The wrapper adds safe in-place rewriting, pipeline support, and customizable skip/force rules.

## Code Map
- `uk2us`: PHP CLI entry point. Resolves the repo root (even when symlinked), loads the upstream converter, and applies local overrides.
- `config/uk2us_rules.json`: JSON config for custom behaviour. Keys:
  - `skip_replacements`: British spellings that should never be converted to their American equivalents.
  - `forced_mappings`: Explicit British→American conversions that must run (case variants are auto-generated).
- `lib/`: Upstream PHP classes and word lists. `AmericanBritishSpellings.php` builds regex tables; the `Words/` directory holds the data.

## Conversion Flow
1. Script instantiates `AmericanBritishSpellings`.
2. `convert_text()` caches `[patterns, replacements]` by calling `build_conversion_rules()`.
3. `build_conversion_rules()` fetches the stock regexes (`GetSpellingsAndReplacements(['language' => 'american'])`) and forwards them to `apply_custom_rules()`.
4. `apply_custom_rules()`:
   - Loads JSON config via `load_custom_rules_config()`, which:
     - Discovers `config/uk2us_rules.json` (or `UK2US_RULES_FILE` env override).
     - Validates JSON and falls back to defaults (`schemata` skip, `modelling` forced).
   - Drops replacements whose American form matches the skip list (case variants generated by `build_case_variants()`).
   - Appends regexes for forced mappings; replacements are case-matched with `match_case()`.
5. Resulting regex arrays feed a single `preg_replace()` call.

## CLI Behaviour
- Accepts multiple targets; rewrites files atomically (`write_atomic()` writes to `tempnam()` then `rename()`).
- Skips directories, unreadable, or unwritable files; emits diagnostics to `STDERR`.
- `-` reads from `STDIN` and writes to `STDOUT` (only once per invocation).
- Exit code: `0` on success, `>0` on any failure encountered.

## Environment & Dependencies
- Requires PHP CLI ≥ 8.0 (syntax uses typed functions and nullsafe checks, but no 8.1+ features yet).
- No external composer dependencies; pure PHP with bundled data.
- Script determines its root with `script_root()` (follows symlinks) so symlinking to `/usr/local/bin/uk2us` is supported.

## Configuration Tips
- To add overrides, edit `config/uk2us_rules.json`. Keep entries lowercase; helper functions add uppercase/capitalised forms automatically.
- Use `UK2US_RULES_FILE` to point to an alternative JSON when scripting (e.g., per-project rule sets).
- When expanding forced mappings, note that existing upstream replacements might already cover your term—check before duplicating.

## Testing & Validation
- Quick syntax check: `php -l uk2us`.
- Smoke test: create a temp file with known words, run `./uk2us file`, inspect changes, and ensure unlisted words remain untouched.
- Use pipeline mode for rapid spot checks: `echo 'modelling schema schemata' | ./uk2us -`.

## Extending
- Additional CLI switches (e.g., dry-run, verbose) should be bolted near the argument parsing block (top of `uk2us`).
- For batch operations or alternate output locations, branch after `convert_text()`—prefer not to mutate the upstream library.
- If adding tests, keep them self-contained (e.g., PHPT or simple PHP scripts) and document them in this file or `README.md`.

## Caveats
- Word lists are large; loading them is the heaviest part. Avoid re-instantiating the converter in loops.
- `preg_replace()` operates with word-boundary regexes from upstream; avoid adding forced mappings that include non-word boundary behaviour without reviewing the impact.
- Any JSON parsing failure falls back to defaults and prints a warning to `STDERR`; guard against noisy shells if you expect quiet output.
